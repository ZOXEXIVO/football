{% extends "../../layouts/layout_game.html" %}

{% block pagetitle %}
Title
{% endblock %}

{% block header %}

<script src="/js/graphics"></script>

<div style="float:left;">
    <div class="club-logo club-default-logo" style="margin-top: 9px;padding: 27px;"></div>
</div>
<div style="float:left;">
    <div class="header-title-block">
        <div>
        </div>
    </div>
</div>

{% endblock %}

{% block leftmenu %}
<div class="left_col scroll-view">
    <div id="sidebar-menu" class="main_menu_side hidden-print main_menu">
        <div class="menu_section">
            <ul class="nav">
                <li><a href="/"><i class="fa fa-home"></i>Home</a></li>
            </ul>
        </div>
        <div class="menu_section">
            <ul class="nav">
                <li><a><i class="fas fa-inbox"></i>Inbox</a></li>
            </ul>
        </div>
        <div class="menu_section">
            <ul class="nav">
            </ul>
        </div>
        <div class="menu_section">
            <ul class="nav">
                <li><a href="/teams/schedule"><i class="fas fa-user-friends"></i>Schedule</a></li>
                <li><a href="/#"><i class="far fa-calendar-alt"></i>Calendar</a></li>
            </ul>
        </div>
    </div>
</div>
{% endblock %}

{% block game_content %}

<br/>
<div class="content">
    <div class="graphics-js" style="width: 100%;height: 100%">
    </div>
</div>


<script>
    let current_time = 0;
    let last_loaded_time = 0;

    let player_data_loading_finished = false;
    let player_data_current_offset = 0;
    let player_data_current_limit = 300;

    let matchData = {
        player: {},
        ball: {
            ballObject: null,
            currentCoordIdx: 0,
            data: []
        }
    };

    const home_color = '#4967d1';
    const away_color = '#ed9061';

    const leagueSlug = '{{ league_slug }}';
    const matchId = '{{ match_id }}';

    const params = {
        fullscreen: false
    };

    // 565 - 385
    // 565 / 4 = 150
    // 385 / 4 = 100
    const pole_coord = {
        tl: {
            x: 38,
            y: 38
        },
        tr: {
            x: 603,
            y: 38
        },
        bl: {
            x: 38,
            y: 422
        },
        br: {
            x: 603,
            y: 422
        }
    };

    const elem = document.body.getElementsByClassName('graphics-js')[0];

    const two = new Two(params).appendTo(elem);
    const group = two.makeGroup();

    group.add(createPole());

    initialDataLoad();

    two.bind('update', update);

    function update(frameCount) {
        if (frameCount % 6 === 0) {
            current_time += 10;

            if (current_time > last_loaded_time - 50) {
                loadData(player_data_current_offset, player_data_current_limit);
            }

            // update players positions
            for (let playerKey in matchData.player) {
                if (!playerKey) {
                    continue;
                }

                let playerData = matchData.player[playerKey];
                if (!playerData) {
                    continue;
                }

                while (playerData.data[playerData.currentCoordIdx] && playerData.data[playerData.currentCoordIdx].timestamp < current_time) {
                    playerData.currentCoordIdx++;
                }

                if (!playerData.data[playerData.currentCoordIdx]) {
                    continue;
                }

                let actualPlayerData = playerData.data[playerData.currentCoordIdx].coord;

                if (!playerData.playerObject || !playerData.playerObject.position) {
                    continue;
                }

                playerData.playerObject.position.set(actualPlayerData.x, actualPlayerData.y);
            }

            // update ball positions            
            while (matchData.ball.data[matchData.ball.currentCoordIdx].timestamp < current_time) {
                matchData.ball.currentCoordIdx++;
            }

            let actualBallData = matchData.ball.data[matchData.ball.currentCoordIdx].coord;

            if (matchData.ball.ballObject && actualBallData) {
                matchData.ball.ballObject.position.set(actualBallData.x, actualBallData.y);
            }
        }
    }

    function createPole() {
        const poleShape = two.makeRectangle(320, 230, 630, 450);
        poleShape.fill = new Two.Texture('/images/pole');
        poleShape.noStroke();

        return poleShape;
    }

    function createBall() {
        let center_x = pole_coord.tl.x + ((pole_coord.tr.x - pole_coord.tl.x) / 2);
        let center_y = pole_coord.tl.y + ((pole_coord.bl.y - pole_coord.tl.y) / 2);

        const ball = two.makeCircle(center_x, center_y, 7);
        ball.noStroke();

        ball.fill = new Two.Texture('/images/ball');

        return ball;
    }

    function initialDataLoad() {
        const url = `/match/${leagueSlug}/${matchId}/details?offset=${0}&limit=${player_data_current_limit}`;

        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        }).then(response => response.json())
            .then(responseJson => {
                try {
                    const home_team_players = responseJson.home_team_players;
                    const away_team_players = responseJson.away_team_players;

                    const playerPositionData = responseJson.player_data;

                    for (let playerKey in playerPositionData) {
                        let playerData = playerPositionData[playerKey];
                        if (!playerData) {
                            continue;
                        }

                        let initial_player_data = playerData[0];

                        let playerCoord = translateXY(initial_player_data[1], initial_player_data[2]);

                        const player_circle = two.makeCircle(playerCoord.x, playerCoord.y, 4);

                        player_circle.fill = home_team_players.includes(playerKey * 1) ? home_color : away_color;

                        group.add(player_circle);

                        const playerFullData = {
                            playerObject: player_circle,
                            currentCoordIdx: 0,
                            data: []
                        };

                        for (let pi = 0; pi < playerData.length; pi++) {
                            let playerRawData = playerData[pi];

                            let timestamp = playerRawData[0];

                            playerFullData.data.push({
                                timestamp: timestamp,
                                coord: translateXY(playerRawData[1], playerRawData[2])
                            });
                        }

                        matchData.player[playerKey] = playerFullData;
                    }

                    const ballPositionData = responseJson.ball_data;

                    for (let pi = 0; pi < ballPositionData.length; pi++) {
                        let ballRawData = ballPositionData[pi];

                        let timestamp = ballRawData[0];

                        let ballCoord = translateXY(ballRawData[1], ballRawData[2]);

                        matchData.ball.data.push({
                            timestamp: timestamp,
                            coord: ballCoord
                        });
                    }

                    last_loaded_time = ballPositionData[ballPositionData.length - 1][0];

                    const ball = createBall();

                    group.add(ball);
                    matchData.ball.ballObject = ball;
                } catch (e) {
                    debugger;
                }
                debugger;
                two.play();
            })

            .catch(error => console.log('Error resulting from json(): ' + error))
    }

    let isLoading = false;

    function loadData(offset, limit) {
        if (isLoading || player_data_loading_finished) {
            return;
        }

        isLoading = true;

        const url = `/match/${leagueSlug}/${matchId}/details?offset=${offset}&limit=${limit}`;

        fetch(url, {
            method: 'GET',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json'
            }
        }).then(response => response.json())
            .then(responseJson => {
                try {
                    player_data_current_offset += limit;

                    const playerPositionData = responseJson.player_data;

                    if (playerPositionData.length === 0) {
                        player_data_loading_finished = true;
                    }

                    for (let playerKey in playerPositionData) {
                        let playerData = playerPositionData[playerKey];
                        if (!playerData) {
                            continue;
                        }

                        for (let pi = 0; pi < playerData.length; pi++) {
                            let playerRawData = playerData[pi];
                            let timestamp = playerRawData[0];

                            matchData.player[playerKey].data.push({
                                timestamp: timestamp,
                                coord: translateXY(playerRawData[1], playerRawData[2])
                            });
                        }
                    }

                    const ballPositionData = responseJson.ball_data;

                    for (let pi = 0; pi < ballPositionData.length; pi++) {
                        let ballRawData = ballPositionData[pi];

                        let timestamp = ballRawData[0];

                        let ballCoord = translateXY(ballRawData[1], ballRawData[2]);

                        matchData.ball.data.push({
                            timestamp: timestamp,
                            coord: ballCoord
                        });
                    }

                    last_loaded_time = ballPositionData[ballPositionData.length - 1][0];

                    isLoading = true;
                } catch (e) {
                    debugger;
                }
            })

            .catch(error => console.log('Error resulting from json(): ' + error))
    }

    function translateXY(x, y) {
        let scaleX = 565 / 150;
        let scaleY = 388 / 100;

        return {
            x: pole_coord.tl.x + x * scaleX,
            y: pole_coord.tl.y + y * scaleY
        }
    }
</script>

{% endblock %}
